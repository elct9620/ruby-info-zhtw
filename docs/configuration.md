# Configuration

Documentation for environment variables and system configuration.

## CloudflareConfig

Location: `src/config.ts`

The `CloudflareConfig` class provides a unified interface for accessing environment variables from Cloudflare Workers bindings.

```typescript
export class CloudflareConfig {
  constructor(private readonly env: Cloudflare.Env) {}
  // Getter methods for each configuration
}
```

## Required Environment Variables

### Email Configuration

| Variable | Type | Description |
|----------|------|-------------|
| `ADMIN_EMAIL` | string | Administrator email for forwarded emails |

### Discord Configuration

| Variable | Type | Description |
|----------|------|-------------|
| `DISCORD_WEBHOOK` | string | Discord Webhook URL for sending summaries |
| `DISCORD_CLIENT_ID` | string | Discord OAuth application ID |
| `DISCORD_CLIENT_SECRET` | string | Discord OAuth application secret |
| `DISCORD_ALLOW_GUILD_ID` | string | Discord server ID for role verification |
| `DISCORD_ALLOW_ROLE_ID` | string | Required Discord role ID |

### AI Configuration

| Variable | Type | Description |
|----------|------|-------------|
| `OPENAI_API_KEY` | string | OpenAI API key for AI summaries |

### Security Configuration

| Variable | Type | Description |
|----------|------|-------------|
| `SECRET_KEY_BASE` | string | Session encryption key (256-bit recommended) |

## Optional Environment Variables

| Variable | Type | Description |
|----------|------|-------------|
| `CF_AI_GATEWAY` | string | Cloudflare AI Gateway base URL |

When `CF_AI_GATEWAY` is set, the getter automatically appends `openai`:

```typescript
get openAiGateway(): string | undefined {
  return this.env.CF_AI_GATEWAY ? `${this.env.CF_AI_GATEWAY}openai` : undefined;
}
```

## Cloudflare Workers Configuration

Location: `wrangler.jsonc`

### Email Binding

```json
"send_email": [
  {
    "name": "core@ruby.aotoki.cloud"
  }
]
```

### Compatibility Settings

- Node.js compatibility mode enabled
- Smart Placement for optimal performance

## Constants

Location: `src/constant.ts`

| Constant | Value | Description |
|----------|-------|-------------|
| `UserAgent` | `'RubyInfoBot/1.0 (...)'` | HTTP User-Agent for API calls |
| `SessionCookieName` | `'_rib_session'` | Session cookie name |
| `SessionDurationMs` | `86400000` | Session validity (24 hours) |

## TypeScript Configuration

Location: `tsconfig.json`

| Setting | Value | Description |
|---------|-------|-------------|
| Target | ES2021 | JavaScript compilation target |
| Module | ESNext | Module system |
| Path alias | `@/*` â†’ `./src/*` | Import shorthand |
| Strict mode | Enabled | Full type checking |

## Type Definitions

Location: `worker-configuration.d.ts`

Auto-generated by `npm run cf-typegen` for Cloudflare Worker environment bindings.

```typescript
interface Env {
  ADMIN_EMAIL: string;
  DISCORD_WEBHOOK: string;
  DISCORD_CLIENT_ID: string;
  DISCORD_CLIENT_SECRET: string;
  DISCORD_ALLOW_GUILD_ID: string;
  DISCORD_ALLOW_ROLE_ID: string;
  OPENAI_API_KEY: string;
  CF_AI_GATEWAY?: string;
  SECRET_KEY_BASE: string;
}
```

## Secrets Management

Environment variables containing sensitive data should be stored as Cloudflare Workers Secrets:

```bash
# Set secrets via Wrangler CLI
npx wrangler secret put DISCORD_CLIENT_SECRET
npx wrangler secret put OPENAI_API_KEY
npx wrangler secret put SECRET_KEY_BASE
```

## Development vs Production

### Development

Use `.dev.vars` file for local development (not committed to git):

```
ADMIN_EMAIL=admin@example.com
DISCORD_WEBHOOK=https://discord.com/api/webhooks/...
DISCORD_CLIENT_ID=...
DISCORD_CLIENT_SECRET=...
OPENAI_API_KEY=sk-...
SECRET_KEY_BASE=...
```

### Production

Set variables via Cloudflare dashboard or Wrangler CLI:

```bash
npx wrangler secret put VARIABLE_NAME
```

## Validation

The `CloudflareConfig` class does not perform validation. Ensure all required environment variables are set before deployment.

Missing variables will result in runtime errors when accessed.
